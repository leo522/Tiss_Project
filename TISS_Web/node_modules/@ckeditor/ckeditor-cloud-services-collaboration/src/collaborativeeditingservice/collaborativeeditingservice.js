/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0x358bc8}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0xf62455 from'./../messagescompressor.js';import _0x55d91a from'./../sessions/sessions.js';import _0x237f4f from'./messages/collaborativeeditingconnectmessage.js';import _0x599130 from'./messages/collaborativeeditingupdatemessage.js';import _0x2718f8 from'./messages/collaborativeeditingreconnectmessage.js';import _0x3dd42a from'./responses/collaborativeeditingresponse.js';import _0x5d263b from'./responses/collaborativeeditingconnectresponse.js';import _0x4c32c1 from'./../websocketgateway/websocketgateway.js';import _0x27b68d from'../ckeditorcloudserviceserror.js';import _0xfea505 from'../errors/ServiceNotConnectedError.js';import _0x3fd258 from'./responses/getdocumentdetailsresponse.js';import _0x36e88d from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;class CollaborativeEditingService extends/* #__PURE__ -- @preserve */
EmitterMixin(){constructor(_0x565ec6,_0x24c7b9){if(super(),!_0x565ec6)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x24c7b9?_0x24c7b9:_0x358bc8(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x565ec6;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x324eea,_0x4d988b={'buffers':[],'types':[]},_0x3ceba1){const _0x547fd7=new _0x237f4f(this['getId'](),_0x4d988b['buffers'],_0x4d988b['types'],this['_bundleVersion'],_0x3ceba1);return this['_connect'](_0x324eea,_0x547fd7);}['reconnect'](_0x183a14,_0x310057){if(this['isConnected']())throw new _0x27b68d('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x183a14);return this['_connect'](_0x183a14,new _0x2718f8(this['getId'](),_0x310057,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x40e2f1=new _0x36e88d(this['getId']());if(!this['_wsGateway'])throw new _0xfea505('Collaborative\x20Editing',this);const _0x1f5556=await this['_wsGateway']['_sendRequest'](0x1,_0x36e88d['TYPE'],_0xf62455['encode'](_0x40e2f1));return _0xf62455['decode'](_0x1f5556,_0x3fd258);}async['sendOperations'](_0x2350ce,_0x452e8c,_0x1b46d7){if(!_0x2350ce||!_0x2350ce['types']||!_0x2350ce['types']['length'])throw new _0x27b68d('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x18cbdd='number'==typeof _0x452e8c?_0x452e8c:parseInt(_0x452e8c);if(!Number['isInteger'](_0x18cbdd)||_0x18cbdd<0x0)throw new _0x27b68d('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x4c2972=new _0x599130(this['getId'](),_0x2350ce['buffers'],_0x2350ce['types'],_0x18cbdd,[],_0x1b46d7);if(!this['_wsGateway']||!this['_isConnected'])throw new _0xfea505('Collaborative\x20Editing',this);const _0xa1e1b5=await this['_wsGateway']['_sendRequest'](0x1,_0x599130['TYPE'],_0xf62455['encode'](_0x4c2972));return _0xf62455['decode'](_0xa1e1b5,_0x3dd42a);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0xfea505('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x55d91a['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x6e1a6f,_0x2c8e90){return _0x55d91a['getConnectedSessions'](_0x6e1a6f,_0x2c8e90,0x1);}async['_connect'](_0x1783bb,_0x226e4f){if(this['isConnected']())return;if(_0x1783bb['state']!==_0x4c32c1['STATE_CONNECTED'])throw new _0x27b68d('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x1783bb);this['_wsGateway']=_0x1783bb,this['stopListening'](_0x1783bb,'change:state');const _0x58a18c=await _0x1783bb['_sendRequest'](0x1,_0x226e4f['constructor']['TYPE'],_0xf62455['encode'](_0x226e4f)),_0x44c37a=_0xf62455['decode'](_0x58a18c,_0x5d263b);return this['listenTo'](_0x1783bb,'change:state',(_0x38f4e6,_0x475014,_0x262e5d)=>this['_onWsGatewayStateChange'](_0x262e5d),{'priority':_0x4c32c1['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x1783bb,_0x44c37a['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x44c37a;}['_connectToChannel'](_0x2b5789,_0x50fcef){this['_channel']=_0x2b5789['_getChannel'](0x1,_0x50fcef),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x599130['TYPE']),(_0x590a48,_0xf5fcec)=>{const _0x5ca07a=_0xf62455['decode'](_0xf5fcec,_0x599130);this['fire']('operationsReceived',_0x5ca07a['baseVersion'],_0x5ca07a['data'],_0x5ca07a['metadata']);});}['_onWsGatewayStateChange'](_0x41a605){_0x41a605===_0x4c32c1['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=0x1;export default CollaborativeEditingService;