/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x27db74 from'./../users/user.js';import _0x1cb2c0 from'./../websocketgateway/websocketgateway.js';import _0xa5c12d from'./responses/sessionsconnectresponse.js';import _0x2981f0 from'./messages/sessionsconnectmessage.js';import _0x2d5fc8 from'./messages/socketconnectmessage.js';import _0x3f5acf from'./messages/socketdisconnectmessage.js';import _0x42ef67 from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{constructor(_0x3f8b68,_0xbc6199){super({'idProperty':'id'}),this['_id']=_0x3f8b68,this['_sessionType']=_0xbc6199,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x5b0e08){this['_wsGateway']=_0x5b0e08,this['stopListening'](_0x5b0e08,'change:state');const _0x3ea32a=new _0x2981f0(this['_id'],this['_sessionType']);let _0x174cd8;try{const _0x33e753=await this['_wsGateway']['_sendRequest'](0x3,_0x2981f0['TYPE'],_0x42ef67['encode'](_0x3ea32a));_0x174cd8=_0x42ef67['decode'](_0x33e753,_0xa5c12d);}catch(_0x33dd7a){_0x174cd8=new _0xa5c12d(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x174cd8['channel'],this['_sessionType']);const _0x42f220=await async function(_0x10cf28,_0x55aa18){const _0x1bcfc5=_0x55aa18['map'](_0x10c0b8=>_0x10c0b8['userId']),_0xe79d60=_0x1bcfc5['length']?await _0x27db74['getMany'](_0x10cf28,_0x1bcfc5):[];return _0x55aa18['map'](_0x57ae39=>{const _0x3fc90d={'id':_0x57ae39['id'],'role':_0x57ae39['role'],'permissions':_0x57ae39['permissions']};return _0x3fc90d['user']=_0x57ae39['userId']&&_0xe79d60['find'](_0x12fb56=>_0x12fb56['id']===_0x57ae39['userId'])||new _0x27db74(),_0x3fc90d;});}(this['_wsGateway'],_0x174cd8['sockets']);for(const _0x2a81dd of _0x42f220)super['add'](_0x2a81dd);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x20fdc0,_0x47146b,_0x56706d)=>this['_onWsGatewayStateChange'](_0x56706d),{'priority':_0x1cb2c0['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0xaa90d0=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0xaa90d0&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0xaa90d0&&this['stopListening']();}}['add'](_0x385f69,_0x372ed6){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x4899dd){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x3152bc,_0x2be278,_0x50ad2a){this['_channel']=_0x3152bc['_getChannel'](_0x50ad2a,_0x2be278),this['_channel']&&(this['_addHandler'](this['_channel'],_0x2d5fc8['TYPE'],async _0x1dd1e6=>{const _0x501553=_0x42ef67['decode'](_0x1dd1e6,_0x2d5fc8);if(-0x1===this['getIndex'](_0x501553['id'])){const _0x343a43={'id':_0x501553['id'],'role':_0x501553['role'],'permissions':_0x501553['permissions']};_0x501553['userId']&&(_0x343a43['user']=await _0x27db74['get'](_0x3152bc,_0x501553['userId'])),super['add'](_0x343a43);}}),this['_addHandler'](this['_channel'],_0x3f5acf['TYPE'],_0x2fc898=>{const _0x5c9cdf=_0x42ef67['decode'](_0x2fc898,_0x3f5acf);-0x1!==this['getIndex'](_0x5c9cdf['id'])&&super['remove'](_0x5c9cdf['id']);}));}async['_onWsGatewayStateChange'](_0xb09312){_0xb09312===_0x1cb2c0['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0xb09312===_0x1cb2c0['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x52c7b0;for(this['_isRunning']=!0x0;_0x52c7b0=this['_eventsQueue']['shift']();){const _0x167f95=this['_handlers']['get'](_0x52c7b0['eventName']);_0x167f95&&await _0x167f95(_0x52c7b0['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x11b04a,_0x399158,_0x2c9c65){const _0x31db2c=_0x11b04a['getEventName'](_0x399158,!0x0);this['listenTo'](_0x11b04a,_0x31db2c,async(_0x224f54,_0x1262fd)=>{const _0x23cd64=_0x224f54['name'];this['_eventsQueue']['push']({'eventName':_0x23cd64,'data':_0x1262fd}),await this['_runQueue']();}),this['_handlers']['set'](_0x31db2c,_0x2c9c65);}}