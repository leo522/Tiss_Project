@model TISS_Web.Models.ArticleContent
@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="~/Img/favicon.svg" />
    <title title="發佈文章">發佈文章</title>
    <script src="~/bootstrap/js/bootstrap.js"></script>
    <script src="~/tinymce/js/tinymce/tinymce.min.js"></script>
    <script src="~/tinymce/js/tinymce/langs/zh_TW.js"></script>
    <link href="~/bootstrap/css/bootstrap.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4" title="發佈文章">發佈文章</h1>
        @using (Html.BeginForm("ArticleCreate", "Tiss", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group mb-4">
                <label for="Title" style="font-size:25px" title="標題">標題</label>
                @Html.TextBoxFor(model => model.Title, new { @class = "form-control", placeholder = "輸入文章標題", required = "required" })
            </div>
            <div class="form-group mb-4">
                <label for="Body" style="font-size:25px" title="內容">內容</label>
                @*@Html.TextAreaFor(model => model.ContentBody, new { @class = "form-control", rows = 5, placeholder = "輸入文章內容" })*@
                @Html.TextAreaFor(model => model.ContentBody, new { @class = "form-control", rows = 5, placeholder = "輸入文章內容", id = "ContentBody" })
            </div>
            <div class="form-group mb-4">
                <label for="ContentType" style="font-size:25px" title="發佈類型">文章發佈類別</label>
                @Html.DropDownList("contentTypeID", (SelectList)ViewBag.Categories, "請選擇文章發佈類別", new { @class = "form-control", multiple = "multiple" })
            </div>
            <div class="form-group mb-4">
                <label for="Tag" style="font-size:25px" title="文章標籤">文章標籤</label>
                @Html.ListBox("tags", (MultiSelectList)ViewBag.Hashtags, new { @class = "form-control", multiple = "multiple" })
            </div>
            <div class="form-group mb-4">
                <label for="ImageFile" style="font-size:25px" title="預覽用圖片">預覽用圖片</label>
                <input type="file" name="imageFile" id="imageFile" class="form-control-file" />
            </div>
            <button type="submit" class="btn btn-primary" title="提交">提交</button>
        }
    </div>
    
<script>
        document.addEventListener('DOMContentLoaded', function () {
            tinymce.init({
                selector: '#ContentBody',
                language: 'zh_TW',
                plugins: 'preview anchor autolink codesample emoticons image link lists media searchreplace table visualblocks wordcount' ,
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | customFileButton |',

                // 字體格式選項
                font_formats: "微軟黑體=Microsoft JhengHei;",

                // 文件和圖片的檔案選擇器
                file_picker_callback: function (callback, value, meta) {
                    if (meta.filetype === 'image') {
                        var input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.onchange = function () {
                            var file = this.files[0];
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                callback(e.target.result, { alt: file.name });
                            };
                            reader.readAsDataURL(file);
                        };
                        input.click();
                    }
                },
                setup: function (editor) {
                    // 自定義按鈕來上傳 .pdf, .doc, .docx 檔案
                    editor.ui.registry.addButton('customFileButton', {
                        text: '插入檔案',
                        onAction: function () {
                            var input = document.createElement('input');
                            input.setAttribute('type', 'file');
                            input.setAttribute('accept', '.pdf,.doc,.docx');

                            input.onchange = function () {
                                var file = this.files[0];
                                var formData = new FormData();
                                formData.append('file', file);

                                // 上傳 PDF 或 DOC 檔案
                                fetch('/Tiss/UploadPDF', { // 檔案上傳 API
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.url) {
                                            // 插入檔案連結到編輯器中
                                            var link = `<a href="${data.url}" download>${file.name}</a>`;
                                            editor.insertContent(link);
                                        } else {
                                            alert('檔案上傳失敗！');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('檔案上傳錯誤:', error);
                                        alert('檔案上傳失敗！');
                                    });
                            };
                            input.click();
                        }
                    });
                },
            });
        });
</script>
</body>
</html>