@model TISS_Web.Models.ArticleContent
@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="~/Img/favicon.svg" />
    <title title="發佈文章">發佈文章</title>
    <script src="~/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.tiny.cloud/1/dnrbo5jub3ln0e23awgulturfk1e6nv5h6s4eh16ob30c6jn/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <link href="~/bootstrap/css/bootstrap.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4" title="發佈文章">發佈文章</h1>
        @using (Html.BeginForm("ArticleCreate", "Tiss", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group mb-4">
                <label for="Title" style="font-size:25px" title="標題">標題</label>
                @Html.TextBoxFor(model => model.Title, new { @class = "form-control", placeholder = "輸入文章標題", required = "required" })
            </div>
            <div class="form-group mb-4">
                <label for="Body" style="font-size:25px" title="內容">內容</label>
                @Html.TextAreaFor(model => model.ContentBody, new { @class = "form-control", rows = 5, placeholder = "輸入文章內容" })
            </div>
            <div class="form-group mb-4">
                <label for="ContentType" style="font-size:25px" title="發佈類型">發佈類型</label>
                @Html.DropDownList("contentTypeID", (SelectList)ViewBag.Categories, "請選擇發佈類型", new { @class = "form-control" })
            </div>
            <div class="form-group mb-4">
                <label for="Tag" style="font-size:25px" title="文章標籤">文章標籤</label>
                @Html.DropDownList("tag", (SelectList)ViewBag.Hashtags, "請選擇標籤", new { @class = "form-control" })
            </div>
            <div class="form-group mb-4">
                <label for="ImageFile" style="font-size:25px" title="預覽用圖片">預覽用圖片</label>
                <input type="file" name="imageFile" id="imageFile" class="form-control-file" />
            </div>
            <button type="submit" class="btn btn-primary" title="提交">提交</button>
        }
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            tinymce.init({
                selector: '#ContentBody',
                language: 'zh_TW',
                plugins: [
                    'advlist', 'autolink', 'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                    'searchreplace', 'wordcount', 'visualblocks', 'visualchars', 'code', 'fullscreen', 'insertdatetime',
                    'media', 'table', 'emoticons', 'help'
                ],
                toolbar: 'insertfile | undo redo | styleselect | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | link image | customFileButton',
                setup: function (editor) {
                    editor.ui.registry.addButton('customFileButton', {
                        text: '插入檔案',
                        onAction: function () {
                            var input = document.createElement('input');
                            input.setAttribute('type', 'file');
                            input.setAttribute('accept', '.pdf,.doc,.docx');

                            input.onchange = function () {
                                var file = this.files[0];
                                var formData = new FormData();
                                formData.append('file', file);

                                fetch('/Tiss/UploadPDF', { // 指向你的上傳 API
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.url) {
                                            var link = `<a href="${data.url}" download>${file.name}</a>`;
                                            editor.insertContent(link);
                                        } else {
                                            alert('檔案上傳失敗！');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('上傳錯誤:', error);
                                        alert('檔案上傳失敗！');
                                    });
                            };
                            input.click();
                        }
                    });
                },
            });
        });
    </script>

</body>
</html>