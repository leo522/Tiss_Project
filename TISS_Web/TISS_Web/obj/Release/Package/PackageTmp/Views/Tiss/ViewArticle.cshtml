@model TISS_Web.Models.ArticleContent
@{
    Layout = "~/Views/Shared/_TissMaster.cshtml";
    var isLoggedIn = Session["LoggedIn"] != null && (bool)Session["LoggedIn"];
    var parentDirectory = ViewBag.ParentDirectory as string;
    var menuItems = ViewBag.ParentMenu as Dictionary<string, List<string>>;

}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <link href="~/site/css/ViewArticleBtnStyle.css" rel="stylesheet" />
    <link href="~/site/css/ViewArticle.css" rel="stylesheet" />
    <link href="~/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <script src="~/tinymce/js/tinymce/tinymce.min.js"></script>
    <script src="~/tinymce/js/tinymce/langs/zh_TW.js"></script>
    <link href="~/site/css/hashTagStyle.css" rel="stylesheet" />
    <script src="~/bootstrap/js/bootstrap.js"></script>
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Lezbh4qAAAAADX1XDuddC9SwZpc1KsA5MMVE2O1"></script>
    <script>
        function onSubmit(token) {
            document.getElementById("msg").submit();
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            grecaptcha.enterprise.execute('6Lezbh4qAAAAADX1XDuddC9SwZpc1KsA5MMVE2O1', { action: 'submit' }).then(function (token) {
                document.getElementById("g-recaptcha-response").value = token;
                document.getElementById("msg").submit();
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("msg").addEventListener("submit", handleFormSubmit);
        });
    </script>
</head>
<body>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v10.0" nonce="xyz">
    </script>
    <div class="container-fluid px-0 mt-header">
        <div class="BasePageLayout">
            <div class="BasePageBanner">
                <div class="Mask"></div>
                <img class="PageBannerItemBg" src="/site/img/banner_research.25875290.jpg" alt="" />
            </div>
            <section class="el-container">
                <aside class="el-aside">
                    <div class="BaseBreadcrumb d-block d-lg-none">
                        <div class="container">
                            <div class="el-breadcrumb" aria-label="Breadcrumb" role="navigation">
                                <span class="el-breadcrumb__item">
                                    <a class="el-breadcrumb__inner" role="link" style="color:black" href="/Tiss/Home">首頁</a>
                                    <i class="fa-solid el-breadcrumb__separator fa-greater-than fa-xs" style="color: #44afe4;"></i>
                                </span>
                                @if (ViewBag.ParentDirectory != null)
                                {
                                    <span class="el-breadcrumb__item">
                                        <span class="el-breadcrumb__inner" style="color:black">@ViewBag.ParentDirectory</span>
                                        <i class="fa-solid el-breadcrumb__separator fa-greater-than fa-xs" style="color: #44afe4;"></i>
                                    </span>
                                }
                                <span class="el-breadcrumb__item current-page" aria-current="page">
                                    <span class="el-breadcrumb__inner" style="color:black">@Html.Raw(Model.Title)</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="content">
                        @if (!string.IsNullOrEmpty(parentDirectory))
                        {
                            <div class="Title">@parentDirectory</div>
                            <ul class="Menu">
                                @foreach (var item in ViewBag.MenuUrls)
                                {
                                    <li span="3">
                                        <a class="MenuLink" href="@item.Value">@item.Key</a>
                                    </li>
                                }
                                @if (isLoggedIn)
                                {
                                    <li span="3">
                                        <a class="MenuLink" href="/Tiss/ArticleCreate" style="color:orange">新增文章</a>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </aside>
                <main class="el-main bg-defaultO4">
                    <div class="MainContainer">
                        <div class="BaseBreadcrumb d-none d-lg-block">
                            <div class="container">
                                <div class="el-breadcrumb" aria-label="Breadcrumb" role="navigation">
                                    <span class="el-breadcrumb__item">
                                        <a class="el-breadcrumb__inner" role="link" style="color:black" href="/Tiss/Home">首頁</a>
                                        <i class="fa-solid el-breadcrumb__separator fa-greater-than fa-xs" style="color: #44afe4;"></i>
                                    </span>
                                    @if (ViewBag.ParentDirectory != null && ViewBag.CurrentSubDirectory != null)
                                    {
                                        <span class="el-breadcrumb__item">
                                            <span class="el-breadcrumb__inner" style="color:black">@ViewBag.ParentDirectory</span>
                                            <i class="fa-solid el-breadcrumb__separator fa-greater-than fa-xs" style="color: #44afe4;"></i>
                                        </span>
                                        <span class="el-breadcrumb__item">
                                            <a class="el-breadcrumb__inner" role="link" style="color:black">@ViewBag.CurrentSubDirectory</a>
                                            <i class="fa-solid el-breadcrumb__separator fa-greater-than fa-xs" style="color: #44afe4;"></i>
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ResearchPage">
                        <div class="HeadInfo">
                            <div class="HeadInfoItem">@ViewBag.FormattedPublishedDate</div>
                            <div class="HeadInfoItem">
                                @if (ViewBag.DisplayHashtags != null && ViewBag.DisplayHashtags.Count > 0)
                                {
                                    foreach (var hashtag in ViewBag.DisplayHashtags)
                                    {
                                        <span class="el-tag el-tag--light">
                                            <span class="el-tag__content">@hashtag</span>
                                        </span>
                                    }
                                }
                            </div>
                        </div>
                        <div class="NewsToolBar">
                            <div class="NewsParams">
                                <div class="NewsParamsItem">
                                    <span>
                                        <i class="fa-solid fa-eye"></i>
                                    </span>
                                    <span>@Model.ClickCount</span>
                                </div>
                            </div>
                        </div>
                        <div class="NewsContent">
                            <div class="ContentBox">
                                <div>
                                    @if (isLoggedIn)
                                    {
                                        <!-- 標題 -->
                                        <form method="post" action="@Url.Action("ViewArticle", "Tiss")" enctype="multipart/form-data">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="Id" value="@Model.Id" />

                                            <!-- 內容 -->
                                            <div class="form-group">
                                                <label for="ContentBody">內容:</label>
                                                @Html.TextAreaFor(model => model.ContentBody, new { @id = "ContentBody", @class = "form-control", rows = 5, placeholder = "輸入文章內容" })
                                            </div>

                                            <div class="form-group mb-4">
                                                <label for="ContentType" style="font-size:25px">文章發佈類別</label>
                                                @Html.DropDownList("ContentTypeId", (SelectList)ViewBag.Categories, "請選擇文章發佈類別", new { @class = "form-control" })
                                            </div>

                                            <div class="form-group mb-4">
                                                <label for="Tag" style="font-size:25px">文章標籤</label>
                                                @Html.ListBox("tags", (MultiSelectList)ViewBag.Hashtags, new { @class = "form-control", multiple = "multiple" })
                                            </div>

                                            <div class="form-group mb-4">
                                                <label for="ImageFile" style="font-size:25px">預覽用圖片</label>
                                                <input type="file" name="imageFile" id="imageFile" class="form-control-file" />
                                            </div>

                                            @if (Model.ImageContent != null)
                                            {
                                                string base64Image = Convert.ToBase64String(Model.ImageContent);
                                                string imageSrc = $"data:image/jpeg;base64,{base64Image}";

                                                <img src="@imageSrc" alt="預覽圖片" style="width:300px; height:auto;" />
                                            }
                                            else
                                            {
                                                <p>目前無圖片</p>
                                            }
                                            <div style="clear: both; margin-top: 10px;">
                                                <button type="submit" class="btn btn-primary mt-3">保存修改</button>
                                            </div>
                                        </form>
                                    }
                                    else
                                    {
                                        <div>
                                            @Html.Raw(Model.ContentBody)
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    @*<div class="col-md-9 text-center mt-5">
                            <a href="/News?ModuleID=N1&amp;CateID=60383e4d-0d5d-40e8-8dcf-bee677b0159d" class="button button-border button-border-thin button-blue"><i class="icon-line-corner-down-left"></i>回列表</a>
                        </div>*@
                    <div class="comments-section">
                        <h3>留言區</h3>
                        <button id="toggle-comments" class="btn btn-light">
                            <i class="fa-regular fa-comment-dots fa-2xl" style="color: #1352e7;"></i><span>檢視留言(@ViewBag.CommentCount 則留言)</span>
                        </button>
                        <div id="comments-container" style="display: none;">
                            @foreach (var comment in ViewBag.Comments)
                            {
                                <div class="comment">
                                    <p>
                                        <strong>@comment.UserName</strong> 說：
                                        @comment.CommentText
                                    </p>
                                    <p class="text-muted">@comment.CommentDate</p>
                                    <!-- 顯示回覆 -->
                                    <div class="comment">
                                        @if (comment.ReplyMessage != null && comment.ReplyMessage.Count > 0)
                                        {
                                            <div class="replies">
                                                @foreach (var reply in comment.ReplyMessage)
                                                {
                                                    <div class="reply">
                                                        <p><strong>@reply.UserName</strong>: @reply.ReplyText</p>
                                                        <small>@reply.ReplyDate</small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <!-- 回覆功能 -->
                                    <button class="btn btn-link reply-btn" data-comment-id="@comment.Id">回覆</button>
                                    <div class="reply-form" id="reply-form-@comment.Id" style="display:none;">
                                        <form action="@Url.Action("PostReply", "Tiss")" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="parentId" value="@comment.Id" />
                                            <input type="hidden" name="articleId" value="@ViewBag.ArticleId" />
                                            @*<input type="hidden" name="userAccount" value="@Model.UserAccount" />*@ <!-- 隱藏欄位 -->
                                            <div class="form-group">
                                                <label for="replyName">名稱:</label>
                                                <input id="replyName" class="form-control" name="replyName" required style="width: 800px;" />
                                            </div>
                                            <div class="form-group">
                                                <label for="replyText">回覆:</label>
                                                <textarea id="replyText" class="form-control" name="replyText" required style="width: 800px;"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">回覆留言</button>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                        <form action="@Url.Action("PostCommentWithCaptcha", "Tiss")" method="post" id="msg">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="articleId" value="@ViewBag.ArticleId" />
                            <input type="hidden" id="g-recaptcha-response" name="recaptchaResponse" />
                            @*<input type="hidden" name="userAccount" value="@Model.UserAccount" />*@ <!-- 隱藏欄位 -->
                            <div class="form-group">
                                <label for="userName">名稱:</label>
                                <input type="text" id="userName" class="form-control" name="userName" required style="width: 200px;" />
                            </div>
                            <div class="form-group">
                                <label for="commentText" style="display: inline-block; width: 50px;">留言:</label>
                                <textarea id="commentText" class="form-control" name="commentText" required style="width: 800px;"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">提交留言</button>
                        </form>
                    </div>
                </main>
            </section>
        </div>
    </div>

    @if (isLoggedIn)
    {
        <script>
    $(document).ready(function () {
    var isLoggedIn = '@Session["LoggedIn"]' === 'True';

    if (isLoggedIn) {
        $('#logoutBtn').show(); // 顯示登出按鈕
    } else {
        $('#loginBtn').show(); // 顯示登入按鈕
    }

    if (window.location.pathname === '/Tiss/Home') {
        $('#adminUser').hide(); // 隱藏管理者按鈕
    }
    });

    $(document).ready(function () {
                tinymce.init({
                    selector: '#ContentBody',
                    language: 'zh_TW',
                    plugins: 'preview anchor autolink codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | customFileButton |',

                    // 字體格式選項
                    font_formats: "微軟黑體=Microsoft JhengHei;",

                    // 文件和圖片的檔案選擇器
                    file_picker_callback: function (callback, value, meta) {
                        if (meta.filetype === 'image') {
                            var input = document.createElement('input');
                            input.setAttribute('type', 'file');
                            input.setAttribute('accept', 'image/*');
                            input.onchange = function () {
                                var file = this.files[0];
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    callback(e.target.result, { alt: file.name });
                                };
                                reader.readAsDataURL(file);
                            };
                            input.click();
                        }
                    },
                    setup: function (editor) {
                        editor.ui.registry.addButton('customFileButton', {
                            text: '插入檔案',
                            onAction: function () {
                                var input = document.createElement('input');
                                input.setAttribute('type', 'file');
                                input.setAttribute('accept', '.pdf,.doc,.docx');

                                input.onchange = function () {
                                    var file = this.files[0];
                                    var formData = new FormData();
                                    formData.append('file', file);

                                    fetch('/Tiss/UploadPDF', {
                                        method: 'POST',
                                        body: formData
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.url) {
                                                var link = `<a href="${data.url}" download>${file.name}</a>`;
                                                editor.insertContent(link);
                                                debugger;
                                            } else {
                                                alert('檔案上傳失敗！');
                                            }
                                        })
                                        .catch(error => {
                                            console.error('檔案上傳錯誤:', error);
                                            alert('檔案上傳失敗！');
                                        });
                                };
                                input.click();
                            }
                        });
                    }
                });
            });
        </script>
    }
    <script>
     $(document).ready(function () {
          var isCommentsVisible = false;
    var commentCount = '@ViewBag.CommentCount';

$('#toggle-comments').click(function () {
    if (isCommentsVisible) {
        $('#comments-container').slideUp();
        $(this).find('span').text('檢視留言(' + commentCount +  '則留言)');
    } else {
        $('#comments-container').slideDown();
        $(this).find('span').text( commentCount +  '則留言');
    }
    isCommentsVisible = !isCommentsVisible;
});
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');
            let lastSubmission = localStorage.getItem('lastSubmission');
            const now = new Date().getTime();

            if (lastSubmission && now - lastSubmission < 60000) { // 設置為 1 分鐘
                form.querySelector('button').disabled = true;
                form.querySelector('button').textContent = '請稍後再提交留言';
            } else {
                form.querySelector('button').disabled = false;
            }

            form.addEventListener('submit', function () {
                localStorage.setItem('lastSubmission', new Date().getTime());
            });
        });

        function containsSuspiciousLinks(commentText) {
            const suspiciousPattern = /(http|https):\/\/[^\s]+/g;
            return suspiciousPattern.test(commentText);
        }

        document.querySelector('form').addEventListener('submit', function (event) {
            const commentText = document.querySelector('#commentText').value;

            if (containsSuspiciousLinks(commentText)) {
                alert('留言中包含可疑的連結，請檢查後再提交。');
                event.preventDefault(); // 阻止表單提交
            }
        });
                });
            /*摺疊回覆留言*/
            document.addEventListener("DOMContentLoaded", function () {
                var replyButtons = document.querySelectorAll(".reply-btn");

                replyButtons.forEach(function (button) {
                    button.addEventListener("click", function () {
                        var commentId = button.getAttribute("data-comment-id");
                        var replyForm = document.getElementById("reply-form-" + commentId);
                        if (replyForm.style.display === "none") {
                            replyForm.style.display = "block";
                        } else {
                            replyForm.style.display = "none";
                        }
                    });
                });
            });
    </script>
</body>
</html>